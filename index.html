<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Next IA - Assistente Virtual Inteligente</title>
    <meta name="description" content="Assistente virtual especializado em LMS Next para esclarecer d√∫vidas e fornecer suporte especializado sobre o uso da plataforma.">
    
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    
    <link rel="stylesheet" href="style.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Inicializando chat...</p>
        </div>
    </div>

    <div class="container">
        <header class="header">...</header>
        <main class="main-content">...</main>
        <footer class="footer">
            <p>&copy; LMS Next IA. Powered by Artificial Intelligence - Em teste (desenvolvendo).</p>
        </footer>
    </div>
    

    <style>
    /* ---------------------------------------------------------------------- */
    /* 1. VARI√ÅVEIS E ESTILIZA√á√ÉO GLOBAL (Baseado no seu c√≥digo)              */
    /* ---------------------------------------------------------------------- */
    :root {
        /* Cores */
        --chat-color-primary: #003EF0;
        --chat-color-secondary: #20b69e;
        --chat-color-text: #333333;
        --chat-color-bg: #f2f4f8; /* Fundo das mensagens do bot */
        --chat-color-white: #ffffff;

        /* Dimens√µes */
        --chat-window-width: 350px;
        --chat-window-height: 500px;
        --chat-toggle-size: 64px;

        /* ‚úÖ URL da Imagem/Avatar para o Cabe√ßalho */
        --chat-header-icon: url('https://i.postimg.cc/rwRJWxjB/chat_ia_1.png');
    }

    /* ---------------------------------------------------------------------- */
    /* 2. ESTRUTURA E POSICIONAMENTO DO WIDGET                                */
    /* ---------------------------------------------------------------------- */
    #custom-chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        font-family: Arial, sans-serif;
    }

    /* Bot√£o de Abrir/Fechar (Toggle) */
    #chat-toggle-button {
        width: var(--chat-toggle-size);
        height: var(--chat-toggle-size);
        background-color: var(--chat-color-primary);
        color: var(--chat-color-white);
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, background-color 0.2s;
    }
    #chat-toggle-button:hover {
        background-color: var(--chat-color-secondary);
    }
    
    /* √çcone (Mantenha o padr√£o, ou substitua por SVG/Imagem) */
    #chat-toggle-button .icon {
        line-height: 1; /* Alinhamento vertical do emoji */
    }

    /* Janela de Chat */
    #chat-window {
        width: var(--chat-window-width);
        height: var(--chat-window-height);
        background-color: var(--chat-color-white);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin-bottom: 10px;
        transform-origin: bottom right;
        opacity: 0;
        transform: scale(0.1);
        transition: all 0.3s ease-in-out;
        pointer-events: none; /* Desabilita intera√ß√µes quando fechado */
    }
    #chat-window.open {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
    }

    /* ---------------------------------------------------------------------- */
    /* 3. COMPONENTES INTERNOS                                                */
    /* ---------------------------------------------------------------------- */

    /* Cabe√ßalho */
    .chat-header {
        background-color: var(--chat-color-primary);
        color: var(--chat-color-white);
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }
    .chat-header-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-image: var(--chat-header-icon);
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
    }
    .chat-header-titles h1 {
        font-size: 1.15rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
    }
    .chat-header-titles p {
        font-size: 0.85rem;
        font-weight: 400;
        margin: 0;
        opacity: 0.8;
    }

    /* √Årea de Mensagens */
    #chat-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: var(--chat-color-white);
    }
    #chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    #chat-messages::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 10px;
    }

    /* Estiliza√ß√£o dos Bal√µes */
    .chat-message {
        display: flex;
        margin-bottom: 10px;
    }
    .chat-message-text {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        word-wrap: break-word;
    }

    /* Mensagem do Usu√°rio */
    .chat-message.user {
        justify-content: flex-end;
    }
    .chat-message.user .chat-message-text {
        background-color: var(--chat-color-secondary);
        color: var(--chat-color-white);
        border-bottom-right-radius: 4px; /* Ponta do bal√£o */
    }

    /* Mensagem do Bot */
    .chat-message.bot {
        justify-content: flex-start;
    }
    .chat-message.bot .chat-message-text {
        background-color: var(--chat-color-bg);
        color: var(--chat-color-text);
        border-bottom-left-radius: 4px; /* Ponta do bal√£o */
    }
    .chat-message.bot strong {
        font-weight: bold; /* Para o texto em negrito (markdown) */
    }
    
    /* Loading (digitando) */
    .loading-dots {
        display: inline-block;
        background-color: var(--chat-color-bg);
        padding: 10px 15px;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        color: var(--chat-color-text);
    }
    .loading-dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: var(--chat-color-text);
        border-radius: 50%;
        margin: 0 2px;
        animation: loading 1s infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes loading {
        0%, 100% { opacity: 0.2; }
        50% { opacity: 1; }
    }

    /* √Årea de Input */
    .chat-input-area {
        padding: 10px 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
    }
    #chat-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        outline: none;
    }
    #send-button {
        background-color: var(--chat-color-primary);
        color: var(--chat-color-white);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    #send-button:hover {
        background-color: var(--chat-color-secondary);
    }
</style>

<div id="custom-chat-container">
    <div id="chat-window">
        <div class="chat-header" id="chat-header">
            <div class="chat-header-avatar"></div>
            <div class="chat-header-titles">
                <h1>Especialista LMS Next! ü§ñ</h1>
                <p>Pergunte o que quiser sobre o LMS Next!</p>
            </div>
        </div>

        <div id="chat-messages">
            </div>

        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Digite sua pergunta..." />
            <button id="send-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 15 2 11 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <button id="chat-toggle-button">
        <span class="icon">üí¨</span>
    </button>
</div>

<script>
    // ----------------------------------------------------------------------
    // 2. CONFIGURA√á√ÉO E L√ìGICA JAVASCRIPT
    // ----------------------------------------------------------------------
    
    // ‚úÖ URL DO SEU WEBHOOK N8N (DO C√ìDIGO FORNECIDO)
    const WEBHOOK_URL = 'https://n8n.lmsnext.com.br/webhook/b1a55f68-a7f8-4e4e-896e-a1c6710f912a';
    
    // Vari√°veis de Elementos
    const chatContainer = document.getElementById('custom-chat-container');
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle-button');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatHeader = document.getElementById('chat-header');

    let isChatOpen = false;
    let isWaitingForResponse = false;
    
    // Simula uma ID de sess√£o (necess√°rio para o n8n/Gemini)
    const sessionId = `session_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

    // --------------------------------------------------
    // FUN√á√ïES DE EXIBI√á√ÉO
    // --------------------------------------------------

    function appendMessage(sender, text) {
        // Converte o texto simples para HTML (suporta negrito simples com **texto**)
        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', sender);
        messageElement.innerHTML = `<div class="chat-message-text">${formattedText}</div>`;
        
        chatMessages.appendChild(messageElement);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-indicator';
        loadingDiv.classList.add('chat-message', 'bot');
        loadingDiv.innerHTML = `<div class="loading-dots"><span></span><span></span><span></span></div>`;
        chatMessages.appendChild(loadingDiv);
        scrollToBottom();
    }

    function removeLoading() {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    function sendInitialMessages() {
        // Mensagens iniciais do seu c√≥digo
        setTimeout(() => {
            appendMessage('bot', 'Ol√°, sou o **LMS Next IA**, seu especialista em EAD!');
            setTimeout(() => {
                appendMessage('bot', 'Como posso te ajudar hoje? Se precisar de ajuda com acesso ou informa√ß√µes de conta, me informe seu **nome e email**.');
            }, 500);
        }, 300);
    }

    // --------------------------------------------------
    // L√ìGICA DE ABERTURA/FECHAMENTO
    // --------------------------------------------------

    function toggleChat() {
        isChatOpen = !isChatOpen;
        chatWindow.classList.toggle('open', isChatOpen);
        
        // Altera o √≠cone do bot√£o
        chatToggle.innerHTML = isChatOpen ? '<span class="icon">‚úñÔ∏è</span>' : '<span class="icon">üí¨</span>';

        if (isChatOpen) {
            scrollToBottom();
            // Envia a mensagem de boas-vindas na primeira abertura
            if (chatMessages.children.length === 0) {
                sendInitialMessages();
            }
        }
    }

    // --------------------------------------------------
    // L√ìGICA DE COMUNICA√á√ÉO (N8N)
    // --------------------------------------------------

    async function sendMessage() {
        const userInput = chatInput.value.trim();
        
        if (!userInput || isWaitingForResponse) return;

        // 1. Enviar mensagem do usu√°rio
        appendMessage('user', userInput);
        chatInput.value = '';
        
        // 2. Mostrar indicador de digita√ß√£o (Loading)
        isWaitingForResponse = true;
        showLoading();

        try {
            // Estrutura do body esperada pelo seu Webhook n8n
            const payload = {
                chatInput: userInput,
                sessionId: sessionId,
                metadata: {
                    user_language: navigator.language || 'pt-BR'
                }
            };

            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            // O n8n geralmente retorna a resposta do bot em um campo 'response' ou 'message'
            // Ajuste 'response.message' se o seu n8n retornar um nome de campo diferente
            const botResponse = data.response || data.message || "Desculpe, houve um erro ao processar sua solicita√ß√£o.";
            
            // 3. Exibir resposta do bot
            removeLoading();
            appendMessage('bot', botResponse);

        } catch (error) {
            console.error('Erro ao conectar com o n8n:', error);
            removeLoading();
            appendMessage('bot', 'Ops! Tivemos um problema de conex√£o. Tente novamente mais tarde.');
        } finally {
            isWaitingForResponse = false;
        }
    }

    // --------------------------------------------------
    // EVENT LISTENERS
    // --------------------------------------------------

    // Abrir/Fechar
    chatToggle.addEventListener('click', toggleChat);
    chatHeader.addEventListener('click', toggleChat); // Fechar ao clicar no cabe√ßalho

    // Envio de mensagem
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

</script>

    <script src="scrips.js"></script>
</body>
</html>
